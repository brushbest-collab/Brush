<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <style>
    body { font-family: system-ui, Segoe UI, Arial; margin: 24px; }
    #title { font-size: 48px; margin: 0 0 18px; }
    #status { color:#444; margin: 6px 0 18px; }
    #btn { padding:10px 14px; font-size:16px; }
    #barWrap { width: 640px; height: 10px; background:#eee; margin-top:12px; }
    #bar { height:100%; width:0; background:#3b82f6; transition: width .15s; }
    #log { width: 980px; height: 240px; white-space: pre; background:#111; color:#0f0; padding:10px; overflow:auto; }
  </style>
</head>
<body>
  <h1 id="title">EVI Brush Desktop</h1>
  <div id="status">Checking...</div>
  <button id="btn" style="display:none">下載模型（自動續傳 / 302 兼容）</button>
  <div id="barWrap"><div id="bar"></div></div>
  <pre id="log"></pre>

<script>
const statusEl = document.getElementById('status');
const btn = document.getElementById('btn');
const bar = document.getElementById('bar');
const logEl = document.getElementById('log');

function log(s){ logEl.textContent += s + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function setBar(cur, tot){
  const p = tot > 0 ? Math.min(100, (cur/tot)*100) : 0;
  bar.style.width = p + '%';
}

window.evi.onLog(msg => log(msg));
window.evi.onProgress(({current,total,label}) => {
  statusEl.textContent = label;
  setBar(current,total);
});

function timeout(ms){ return new Promise(r => setTimeout(() => r('timeout'), ms)); }

async function boot() {
  // 5 秒超時的 PBS 檢查
  const res = await Promise.race([window.evi.checkPbs(), timeout(5000)]);
  if (res === 'ok') {
    statusEl.textContent = 'Python bootstrap found. 若未安裝模型，請點下方「下載模型」。';
  } else if (res === 'missing') {
    statusEl.textContent = 'Python bootstrap not found（請確認安裝包是否完整）。仍可先下載模型。';
  } else {
    statusEl.textContent = '檢查逾時，仍可直接下載模型。';
  }
  btn.style.display = 'inline-block';
}

btn.addEventListener('click', async () => {
  btn.disabled = true;
  setBar(0,1);
  try {
    // 依你的 Release 實際設定修改
    await window.evi.startModels({
      owner: 'brushbest-collab',
      repo: 'Brush',
      tag: 'v73',
      baseName: 'model-pack.7z',
      parts: 19,
      outDir: null
    });
    statusEl.textContent = '全部模型分卷下載完成。';
    setBar(1,1);
  } catch (e) {
    statusEl.textContent = '下載失敗：' + (e?.message || e);
    log('ERROR: ' + (e?.stack || e));
  } finally {
    btn.disabled = false;
  }
});

boot();
</script>
</body>
</html>
