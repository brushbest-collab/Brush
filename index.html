<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline';" />
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial; margin:24px;}
    h1{font-size:52px;margin:0 0 8px;}
    #status{margin:8px 0 16px;color:#333}
    .row{display:flex;gap:10px;align-items:center;margin:6px 0}
    button{padding:10px 16px;border:1px solid #ccc;border-radius:8px;background:#fff;cursor:pointer}
    button.primary{background:#2d6cdf;color:#fff;border-color:#2d6cdf}
    #modelRoot{font-weight:600;margin-left:8px}
    progress{width:100%;height:12px;border:1px solid #ddd;border-radius:6px}
    #log{background:#0e0e0e;color:#8fdf8f;padding:12px;border-radius:8px;white-space:pre-wrap;height:300px;overflow:auto}
    small.muted{color:#777}
  </style>
</head>
<body>
  <h1>EVI Brush Desktop</h1>
  <div id="status">Checking...</div>

  <div class="row">
    <button id="btnPick">選擇模型資料夾</button>
    <span id="modelRoot">--</span>
  </div>

  <progress id="bar" max="1" value="0" style="margin:8px 0 10px;"></progress>

  <div class="row">
    <button id="btnDownload">下載模型（自動續傳 / 302 兼容）</button>
    <button id="btnDesign" class="primary">開啟設計 / 生成</button>
  </div>

  <div id="log"></div>
  <p><small class="muted">判定「已安裝」條件：存在 <code>sdxl-turbo/sd_xl_turbo_1.0(.fp16).safetensors</code>（&gt;100MB）。</small></p>

  <script>
    const $ = sel => document.querySelector(sel);
    const logEl = $('#log');
    function log(s){ logEl.textContent += (s + '\n'); logEl.scrollTop = logEl.scrollHeight; }

    async function refresh(){
      const st = await window.api.getState();
      $('#modelRoot').textContent = st.modelRoot;
      $('#bar').value = 0;
      if (st.bootstrap) {
        $('#status').textContent = st.installed
          ? 'Python bootstrap found. 模型已安裝。'
          : 'Python bootstrap found. 模型未安裝。';
      } else {
        $('#status').textContent = 'Bootstrap 未就緒。';
      }
    }

    window.api.onLog(s => log('[ui] ' + s));
    window.api.onProgress(v => { $('#bar').value = v; });

    $('#btnPick').onclick = async () => {
      const r = await window.api.pickModelDir();
      if (r) { $('#modelRoot').textContent = r.modelRoot; await refresh(); }
    };

    $('#btnDownload').onclick = async () => {
      log('開始下載模型...');
      try {
        await window.api.downloadModel();
        await refresh();
      } catch (e) {
        alert('下載失敗：' + e.message);
      }
    };

    $('#btnDesign').onclick = async () => {
      // 先確認已安裝
      const st = await window.api.getState();
      if (!st.installed) { alert('尚未安裝模型，請先下載或指定模型資料夾。'); return; }
      await window.api.openDesign();
    };

    refresh();
  </script>
</body>
</html>
