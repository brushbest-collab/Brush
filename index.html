<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>EVI Brush Desktop</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline';"/>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Arial,"Microsoft JhengHei",sans-serif;margin:24px}
    h1{font-size:56px;margin:0 0 8px}
    .row{display:flex;gap:12px;align-items:center;margin:12px 0}
    .btn{padding:10px 14px;border:1px solid #c7c7c7;border-radius:8px;background:#f7f7f7;cursor:pointer}
    .btn.primary{background:#2b6be4;color:#fff;border-color:#2b6be4}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{padding:6px 10px;border-radius:20px;background:#eef;display:inline-block}
    #bar{height:10px;border-radius:6px;background:linear-gradient(90deg,#4e79ff,#4ee1ff);opacity:.6;margin:10px 0}
    #log{background:#0e0e0e;color:#9ae997;font-family:ui-monospace,Menlo,Consolas,monospace;
         padding:14px;border-radius:10px;height:360px;overflow:auto;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>EVI Brush Desktop</h1>

  <div class="row"><span id="checkLabel">Checking...</span></div>

  <div class="row">
    <button id="btnPick" class="btn">選擇模型資料夾</button>
    <span id="path" class="pill">--</span>
  </div>

  <div id="bar"></div>

  <div class="row">
    <button id="btnDownload" class="btn">下載模型（自動續傳 / 302 兼容）</button>
    <button id="btnDesign" class="btn primary">開啟設計 / 生成</button>
  </div>

  <div id="log"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const log = (m) => { const el = $('#log'); el.textContent += `[ui] ${m}\n`; el.scrollTop = el.scrollHeight; };
    window.evi?.onLog((m)=>log(m));

    async function getStateSafe(timeoutMs = 5000) {
      try {
        const p = window.evi.getState();
        const t = new Promise(resolve => setTimeout(() => resolve({ timeout: true }), timeoutMs));
        return await Promise.race([p, t]);
      } catch (e) {
        return { ok:false, message:String(e) };
      }
    }

    async function init() {
      $('#btnPick').disabled = false;     // 先放開，避免卡住時不能選
      $('#btnDownload').disabled = false;
      $('#btnDesign').disabled = false;

      const st = await getStateSafe();
      if (st?.timeout) {
        log('狀態查詢逾時（已啟用手動操作）。');
        $('#checkLabel').textContent = '狀態查詢逾時（可手動指定模型資料夾）';
      } else if (st?.ok) {
        $('#checkLabel').textContent = st.bootstrap ? 'Python bootstrap found.' : 'Python bootstrap not found.';
        $('#path').textContent = st.modelRoot || '--';
        log(`state received: bootstrap=${st.bootstrap}, modelRoot=${st.modelRoot || '(none)'}`);
      } else {
        $('#checkLabel').textContent = '狀態讀取失敗（可手動操作）。';
        log(`state error: ${st?.message || 'unknown'}`);
      }
    }

    $('#btnPick').addEventListener('click', async () => {
      const r = await window.evi.pickModelDir();
      if (!r?.canceled && r?.modelRoot) {
        $('#path').textContent = r.modelRoot;
        log(`選擇模型資料夾：${r.modelRoot}`);
      } else {
        if (r?.error) log(`選擇模型資料夾失敗：${r.error}`);
      }
    });

    $('#btnDownload').addEventListener('click', async () => {
      log('開始下載模型（示範）...');
      await window.evi.startDownload({});
    });

    $('#btnDesign').addEventListener('click', async () => {
      await window.evi.openDesign();
    });

    init();
  </script>
</body>
</html>
