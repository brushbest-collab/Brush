<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">
  <style>
    body { font-family: system-ui, 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 18px; }
    h1 { font-size: 40px; margin: 0 0 10px; }
    .hint { color: #555; margin-bottom: 14px; }
    .row { display: flex; gap: 12px; align-items: center; margin: 8px 0; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #bbb; background: #eef3ff; cursor: pointer; }
    button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
    input.path, input.text { padding: 10px; border-radius: 8px; border: 1px solid #ccd; background: #f7f9ff; }
    input.path { width: 340px; }
    input.text { width: 320px; }
    .bar { height: 8px; background: #cfe3ff; border-radius: 6px; overflow: hidden; margin: 10px 0 14px; }
    .bar > .fill { height: 100%; width: 0%; background: linear-gradient(90deg,#3b82f6,#60a5fa); transition: width .15s; }
    pre.log { background:#0f1217; color:#d3ffd3; padding:10px; border-radius:8px; height: 360px; overflow:auto; white-space:pre-wrap; }
    details { margin: 8px 0 14px; }
    details > summary { cursor: pointer; user-select: none; }
  </style>
  <script>
    window.store = window.store || { getState: async () => null, setState: async () => false };
    window.electron = window.electron || { onLog: () => () => {}, onProgress: () => () => {}, openDir: async () => null, invoke: async () => null };
  </script>
</head>
<body>
  <h1>EVI Brush Desktop</h1>
  <div class="hint" id="bootstrap">Checking...</div>

  <div class="row">
    <button id="btnPick">選擇模型資料夾</button>
    <input id="txtRoot" class="path" value="--" readonly />
  </div>

  <details>
    <summary>設定（GitHub repo / tag / token）</summary>
    <div class="row">
      <label style="width:80px;">Repo</label>
      <input id="cfgRepo" class="text" placeholder="owner/repo" />
      <label style="width:60px;">Tag</label>
      <input id="cfgTag" class="text" placeholder="v105" />
    </div>
    <div class="row">
      <label style="width:80px;">Token</label>
      <input id="cfgToken" class="text" placeholder="ghp_***（私有必填）" />
      <button id="btnSaveCfg">儲存設定</button>
      <small id="cfgStatus" style="color:#555;"></small>
    </div>
  </details>

  <div class="bar"><div class="fill" id="bar"></div></div>

  <div class="row">
    <button id="btnDownload">下載模型（自動續傳 / 302 兼容）</button>
    <button id="btnGo" class="primary">開啟設計 / 生成</button>
  </div>

  <pre class="log" id="log"></pre>

  <script>
  (async function(){
    const $ = sel => document.querySelector(sel);
    const log = (m) => { const el = $('#log'); el.textContent += ((typeof m==='string'?m:JSON.stringify(m)) + '\n'); el.scrollTop = el.scrollHeight; };

    try {
      const modelRoot = await window.store.getState('modelRoot');
      const bootstrap  = await window.store.getState('bootstrap');
      $('#txtRoot').value = modelRoot || '--';
      $('#bootstrap').textContent = bootstrap ? 'Python bootstrap found.' : 'Python bootstrap not found（請確認安裝包是否完整）';

      const cfg = await window.electron.invoke('cfg:get');
      $('#cfgRepo').value  = cfg.repo  || '';
      $('#cfgTag').value   = cfg.tag   || '';
      $('#cfgToken').value = cfg.token || '';
    } catch (err) { $('#bootstrap').textContent = '初始化失敗：' + (err?.message || err); }

    $('#btnSaveCfg').addEventListener('click', async () => {
      const repo  = $('#cfgRepo').value.trim();
      const tag   = $('#cfgTag').value.trim();
      const token = $('#cfgToken').value.trim();
      const ok = await window.electron.invoke('cfg:set', { repo, tag, token });
      $('#cfgStatus').textContent = ok ? '已儲存（下次下載即生效）' : '儲存失敗';
      log(ok ? '[cfg] saved.' : '[cfg] save failed.');
    });

    $('#btnPick').addEventListener('click', async () => {
      const p = await window.electron.openDir();
      if (!p) return;
      $('#txtRoot').value = p;
      await window.store.setState('modelRoot', p);
      log('[ui] 選擇模型資料夾：' + p);
    });

    $('#btnDownload').addEventListener('click', async () => {
      try {
        const res = await window.electron.invoke('model:download');
        if (res === true) log('[ui] 下載與解壓流程完成。');
        else if (res === 'cancelled') log('[ui] 已取消。若要用本機分卷，請把 model-pack.7z.001~N 置於同一資料夾，再選第 1 個 .001 檔。');
      } catch (err) {
        const msg = (err && err.message) ? err.message : String(err);
        log('[ui] 下載/解壓錯誤：' + msg);
        alert('下載/解壓失敗：' + msg);
      }
    });

    $('#btnGo').addEventListener('click', async () => {
      try { await window.electron.invoke('designer:open'); } catch (err) { log('[ui] 打開設計器錯誤：' + ((err && err.message) ? err.message : err)); }
    });

    window.electron.onLog((payload) => log(payload));
    window.electron.onProgress((pct) => { $('#bar').style.width = String(pct || 0) + '%'; });
  })();
  </script>
</body>
</html>
