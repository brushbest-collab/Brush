<script>
  // 如果某次 preload 沒載到，就不讓 UI 直接 throw
  window.store = window.store || {
    getState: async () => null,
    setState: async () => false
  };
  window.electron = window.electron || {
    onLog: () => () => {},
    openDir: async () => null,
    invoke: async () => null
  };
</script>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <!-- 放寬 CSP，避免 inline script 被擋（你之前的錯誤） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline';">

  <style>
    body { font-family: system-ui, 'Segoe UI', 'Microsoft JhengHei', sans-serif; margin: 18px; }
    h1 { font-size: 40px; margin: 0 0 10px; }
    .hint { color: #555; margin-bottom: 14px; }
    .row { display: flex; gap: 12px; align-items: center; margin: 8px 0; }
    button { padding: 10px 16px; border-radius: 8px; border: 1px solid #bbb; background: #eef3ff; cursor: pointer; }
    button.primary { background: #3b82f6; color: white; border-color: #3b82f6; }
    input.path { width: 340px; padding: 10px; border-radius: 8px; border: 1px solid #ccd; background: #f7f9ff; }
    .bar { height: 8px; background: #cfe3ff; border-radius: 6px; overflow: hidden; margin: 10px 0 14px; }
    .bar > .fill { height: 100%; width: 0%; background: linear-gradient(90deg,#3b82f6,#60a5fa); transition: width .15s; }
    pre.log { background:#0f1217; color:#d3ffd3; padding:10px; border-radius:8px; height: 360px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h1>EVI Brush Desktop</h1>

  <div class="hint" id="bootstrap">Checking...</div>

  <div class="row">
    <button id="btnPick">選擇模型資料夾</button>
    <input id="txtRoot" class="path" value="--" readonly />
  </div>

  <div class="bar"><div class="fill" id="bar"></div></div>

  <div class="row">
    <button id="btnDownload">下載模型（自動續傳 / 302 兼容）</button>
    <button id="btnGo" class="primary">開啟設計 / 生成</button>
  </div>

  <pre class="log" id="log"></pre>

<script>
(async function(){
  const $ = sel => document.querySelector(sel);
  const log = (m) => {
    const el = $('#log');
    el.textContent += (m + '\n');
    el.scrollTop = el.scrollHeight;
  };

  // 初始狀態
  try {
    const state = await window.evi.getState();
    $('#txtRoot').value = state.modelRoot || '--';
    $('#bootstrap').textContent = state.bootstrap ? 'Python bootstrap found.' : 'Python bootstrap not found（請確認安裝包是否完整）';
  } catch (err) {
    $('#bootstrap').textContent = '初始化失敗：' + err.message;
  }

  // 事件
  $('#btnPick').addEventListener('click', async () => {
    try {
      const p = await window.evi.pickModelRoot();
      $('#txtRoot').value = p;
      log(`[ui] 選擇模型資料夾：${p}`);
    } catch(e){}
  });

  $('#btnDownload').addEventListener('click', async () => {
    try {
      await window.evi.downloadModel();
      log('[ui] 下載與解壓流程完成。');
    } catch (err) {
      log(`[ui] 下載/解壓錯誤：${err.message}`);
      alert('下載/解壓失敗：' + err.message);
    }
  });

  $('#btnGo').addEventListener('click', async () => {
    await window.evi.openDesigner();
  });

  // 從主程序接收日志、進度
  window.evi.onLog((m) => log(m));
  window.evi.onProgress((p) => {
    $('#bar').style.width = (p || 0) + '%';
  });
})();
</script>
</body>
</html>
