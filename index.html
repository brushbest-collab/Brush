<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Microsoft JhengHei", sans-serif; margin: 24px; }
    h1 { font-size: 42px; margin: 0 0 16px; }
    .muted { color:#666; }
    .row { margin: 14px 0; }
    button { padding: 8px 14px; font-size: 14px; }
    #log { width:100%; height:260px; background:#111; color:#9f9; padding:10px; overflow:auto; white-space: pre; }
    #prog { width: 96%; height: 10px; background: #e6e6e6; margin: 12px 0; border-radius: 5px; position: relative; }
    #bar { height: 100%; width: 0%; background: #3b82f6; border-radius: 5px; transition: width .2s; }
  </style>
</head>
<body>
  <h1>EVI Brush Desktop</h1>
  <div id="status" class="muted">Checking…</div>

  <div id="actions" style="display:none;">
    <div class="row">
      <button id="btnChoose">選擇模型資料夾</button>
      <span id="modelRoot" class="muted"></span>
    </div>
    <div id="prog"><div id="bar"></div></div>
    <div class="row">
      <button id="btnDownload">下載模型（自動續傳 / 302 兼容）</button>
    </div>
    <div class="row">
      <button id="btnOpenGen" disabled>開啟設計 / 生成頁</button>
    </div>
    <div class="row">
      <div id="log"></div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const statusEl = $('#status');
    const actions = $('#actions');
    const modelRootEl = $('#modelRoot');
    const bar = $('#bar');
    const logEl = $('#log');

    const log = (msg='') => { 
      const line = `[ui] ${new Date().toLocaleTimeString()} ${msg}\n`;
      logEl.textContent += line; 
      logEl.scrollTop = logEl.scrollHeight;
      window.evi?.log?.(msg);
    };

    function showState(s) {
      console.log('state:', s);
      log(`state received: bootstrap=${s?.bootstrap?.ok}, modelRoot=${s?.modelRoot}`);
      modelRootEl.textContent = s?.modelRoot || '';
      if (!s?.bootstrap?.ok) {
        statusEl.innerHTML = 'Python bootstrap not found（請確認安裝包是否完整）';
        actions.style.display = 'block';
        $('#btnOpenGen').disabled = true;
        return;
      }
      statusEl.textContent = 'Python bootstrap found. 模型未安裝。';
      actions.style.display = 'block';
      // 這裡你可以檢查模型是否已存在，存在就啟用生成頁
      $('#btnOpenGen').disabled = false;
    }

    // Watchdog：5 秒內沒有任何狀態，就提醒
    let watchdog = setTimeout(()=>{
      statusEl.innerHTML = '仍在 Checking… 如果長時間無反應，請打開開發者工具（Ctrl+Shift+I）檢查 console 錯誤。';
      log('watchdog: no state within 5s');
    }, 5000);

    // 拉一次狀態 + 訂閱 push
    (async () => {
      try {
        const s = await window.evi.getState();
        clearTimeout(watchdog);
        showState(s);
      } catch (e) {
        console.error(e);
        log('getState failed: '+e);
      }
      const off = window.evi.onState((s) => {
        clearTimeout(watchdog);
        showState(s);
      });
      window.addEventListener('beforeunload', off);
    })();

    // UI handlers（下載模型流程請接你前面的 downloader；此處只放占位與進度條示範）
    $('#btnChoose').addEventListener('click', async () => {
      const r = await window.evi.chooseModelDir();
      if (!r?.canceled && r?.modelRoot) {
        modelRootEl.textContent = r.modelRoot;
        log('模型根目錄：'+r.modelRoot);
      }
    });

    $('#btnDownload').addEventListener('click', async () => {
      log('開始下載模型（示範用）');
      // 示範進度條（這裡請串接你的真正下載流程）
      let p = 0;
      const t = setInterval(()=>{
        p = Math.min(100, p+5);
        bar.style.width = p + '%';
        if (p === 100) {
          clearInterval(t);
          log('示範下載完成');
        }
      }, 150);
    });

    $('#btnOpenGen').addEventListener('click', () => {
      log('TODO: 進入生成頁（尚未實作路由）');
      alert('生成頁示範：這裡接你的鞋款設計 / Prompt UI。');
    });
  </script>
</body>
</html>
