<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>EVI Brush Desktop</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f1a;--card:#111827;--muted:#9aa3b2;--primary:#3b82f6;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:#fff;color:#0f172a;font-family:Segoe UI,system-ui,Helvetica,Arial}
    h1{font-size:40px;letter-spacing:.5px;margin:0 0 8px}
    .muted{color:#475569}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{height:40px;padding:0 14px;border:1px solid #cbd5e1;background:#f8fafc;border-radius:8px;font-weight:600;cursor:pointer}
    button.primary{background:#2563eb;border-color:#1d4ed8;color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    input,select,textarea{padding:10px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
    textarea{width:100%;min-height:88px;resize:vertical}
    .bar{height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;margin:16px 0}
    .bar>div{height:100%;width:0;background:#3b82f6;transition:width .25s}
    .card{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:14px}
    .panel{display:none}
    .panel.show{display:block}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .log{height:260px;background:#0f172a;color:#bcdefd;border-radius:8px;padding:10px;overflow:auto;font-family:Consolas,monospace;font-size:13px}
    .preview{width:100%;max-width:512px;border-radius:12px;border:1px solid #e2e8f0;background:#f1f5f9}
    .tag{padding:2px 8px;border-radius:999px;background:#e2e8f0;color:#334155;font-weight:600}
  </style>
</head>
<body>
  <h1>EVI Brush Desktop</h1>
  <div class="muted" id="status">Checkingâ€¦</div>

  <!-- å•Ÿå‹•èˆ‡æ¨¡å‹å®‰è£é¢ -->
  <section id="bootstrap" class="panel">
    <div class="row" style="margin:14px 0">
      <button id="btnPick">é¸æ“‡æ¨¡å‹è³‡æ–™å¤¾</button>
      <span class="tag" id="modelRootTag"></span>
    </div>

    <div class="bar"><div id="barFill"></div></div>

    <div class="row" style="margin:12px 0">
      <button id="btnDownload">ä¸‹è¼‰æ¨¡å‹ï¼ˆè‡ªå‹•çºŒå‚³ / 302 å…¼å®¹ï¼‰</button>
      <button id="btnGo" class="primary">é–‹å•Ÿè¨­è¨ˆ / ç”Ÿæˆé </button>
    </div>

    <div class="log" id="log"></div>
  </section>

  <!-- ç”Ÿæˆé  -->
  <section id="gen" class="panel">
    <div class="grid two">
      <div class="card">
        <div class="grid">
          <label>é‹æ¬¾é¢¨æ ¼
            <select id="style">
              <option value="running">ğŸƒ è·‘é‹ / é‹å‹•é‹</option>
              <option value="basketball">ğŸ€ ç±ƒçƒé‹</option>
              <option value="skate">ğŸ›¹ æ»‘æ¿é‹</option>
              <option value="trail">â›°ï¸ è¶Šé‡é‹</option>
              <option value="retro">ğŸ å¾©å¤çƒé‹</option>
              <option value="minimal">ğŸŒ« ç°¡ç´„ç™½é‹</option>
            </select>
          </label>

          <label>Prompt
            <textarea id="prompt" placeholder="Describe the sneakerâ€¦"></textarea>
          </label>

          <label>Negative Prompt
            <textarea id="neg" placeholder="What to avoidâ€¦"></textarea>
          </label>

          <div class="row">
            <label>å¯¬ <input id="w" type="number" value="512" min="256" step="64" style="width:110px"></label>
            <label>é«˜ <input id="h" type="number" value="512" min="256" step="64" style="width:110px"></label>
            <label>æ­¥æ•¸ <input id="steps" type="number" value="20" min="1" max="100" style="width:110px"></label>
            <label>CFG <input id="cfg" type="number" value="5" min="1" max="20" step="0.5" style="width:110px"></label>
            <label>Seed <input id="seed" type="number" value="-1" style="width:140px"></label>
          </div>

          <div class="row">
            <button id="btnGen" class="primary">é–‹å§‹ç”Ÿæˆï¼ˆç¤ºç¯„ï¼‰</button>
            <span class="muted" id="genHint"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted" style="margin-bottom:8px">é è¦½</div>
        <img id="preview" class="preview" alt="preview" />
      </div>
    </div>

    <div class="log" id="log2" style="margin-top:12px"></div>
  </section>

<script>
const $ = (sel) => document.querySelector(sel);
const log = (s, box = '#log') => {
  const el = $(box);
  if (!el) return;
  const atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 6;
  el.textContent += (el.textContent ? '\n' : '') + s;
  if (atBottom) el.scrollTop = el.scrollHeight;
};
window.evi.onLog((m)=>log(m));

const barFill = $('#barFill');
function setBar(p){ barFill.style.width = (Math.max(0, Math.min(100, p)) + '%'); }

const statusEl = $('#status');
const rootTag = $('#modelRootTag');

function show(id){
  for(const p of document.querySelectorAll('.panel')) p.classList.remove('show');
  $(id).classList.add('show');
}

function applyStyleTemplate(){
  const style = $('#style').value;
  let tmpl = '';
  switch(style){
    case 'running':   tmpl = 'modern running sneaker, knit upper, breathable mesh, TPU cage, cushioned midsole, vibrant accents'; break;
    case 'basketball':tmpl = 'high-top basketball shoe, ankle strap, carbon plate, bold color blocking, court-ready traction'; break;
    case 'skate':     tmpl = 'low-top skate shoe, suede upper, reinforced toecap, vulcanized sole, gum outsole, street vibe'; break;
    case 'trail':     tmpl = 'trail running shoe, rugged outsole lugs, rock plate, ripstop upper, outdoor, muddy terrain'; break;
    case 'retro':     tmpl = 'retro basketball sneaker, 90s style, leather panels, vintage colorway, thick midsole'; break;
    case 'minimal':   tmpl = 'minimalist clean white sneaker, smooth leather, subtle stitching, lifestyle, studio lighting'; break;
  }
  $('#prompt').value = tmpl;
  $('#neg').value = 'blurry, lowres, deformed, extra limbs, watermark, text';
}
$('#style').addEventListener('change', applyStyleTemplate);

// åˆå§‹
(async ()=>{
  const st = await window.evi.getState();
  statusEl.textContent = st.bootstrap
    ? (st.modelInstalled ? 'Python bootstrap found. æ¨¡å‹å·²å®‰è£ã€‚' : 'Python bootstrap found. æ¨¡å‹æœªå®‰è£ã€‚')
    : 'Python bootstrap not foundï¼ˆè«‹ç¢ºèªå®‰è£åŒ…æ˜¯å¦å®Œæ•´ï¼‰';

  rootTag.textContent = st.modelRoot || '(å°šæœªæŒ‡å®š)';
  show('#bootstrap');
  setBar(st.modelInstalled ? 100 : 30);
  applyStyleTemplate();
})();

// é¸æ¨¡å‹è³‡æ–™å¤¾
$('#btnPick').addEventListener('click', async ()=>{
  const r = await window.evi.selectModelDir();
  if (r?.ok){
    rootTag.textContent = r.path || '';
    setBar(r.modelInstalled ? 100 : 40);
  }
});

// ä¸‹è¼‰ï¼ˆç¤ºç¯„ï¼‰
$('#btnDownload').addEventListener('click', async ()=>{
  setBar(50);
  const r = await window.evi.downloadModel();
  setBar(100);
  if (r?.ok) log('æ¨¡å‹ä¸‹è¼‰å®Œæˆï¼ˆç¤ºç¯„ï¼‰');
});

// é€²å…¥ç”Ÿæˆé 
$('#btnGo').addEventListener('click', async()=>{
  const r = await window.evi.openGenerator();
  if (!r?.ok){
    alert(r?.message || 'å°šæœªå®‰è£æ¨¡å‹');
    return;
  }
  statusEl.textContent = 'ç”Ÿæˆé ';
  show('#gen');
});

// ç”Ÿæˆï¼ˆç¤ºç¯„ï¼‰
$('#btnGen').addEventListener('click', async()=>{
  $('#btnGen').disabled = true;
  $('#genHint').textContent = 'Processingâ€¦';
  const payload = {
    style: $('#style').value,
    prompt: $('#prompt').value.trim(),
    negative: $('#neg').value.trim(),
    width: Number($('#w').value || 512),
    height: Number($('#h').value || 512),
    steps: Number($('#steps').value || 20),
    cfg: Number($('#cfg').value || 5),
    seed: Number($('#seed').value || -1)
  };
  try{
    const r = await window.evi.generate(payload);
    if (r?.ok && r.imageDataUrl){
      $('#preview').src = r.imageDataUrl;
      log('[gen] ç”Ÿæˆå®Œæˆï¼ˆç¤ºç¯„ï¼‰', '#log2');
    }else{
      log('[gen] ç”Ÿæˆå¤±æ•—', '#log2');
      alert('ç”Ÿæˆå¤±æ•—ï¼ˆç¤ºç¯„ï¼‰');
    }
  }catch(err){
    log(`[gen] error: ${err?.message||err}`, '#log2');
    alert('ç”Ÿæˆå¤±æ•—ï¼š' + (err?.message||err));
  }finally{
    $('#btnGen').disabled = false;
    $('#genHint').textContent = '';
  }
});
</script>
</body>
</html>
